name: Assignment 1 CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Unit Tests
        run: |
          # Product Service
          cd product-service && mvn test
          cd ..
          
          # Order Service
          cd order-service && mvn test
          cd ..

  docker-pipeline:
    name: Docker Build & Integration Test
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker
        run: |
          # Install Docker and Docker Compose
          sudo apt-get update
          sudo apt-get install -y docker.io docker-compose
          
          # Check versions
          docker --version
          docker-compose --version

      - name: Build Docker Images
        run: |
          echo "Building Docker images..."
          docker build -t product-service ./product-service/
          docker build -t order-service ./order-service/
          
          echo "Images created:"
          docker images | grep service

      - name: Start Services
        run: |
          echo "Starting services with Docker Compose..."
          docker-compose up -d
          sleep 40
          
          echo "Running containers:"
          docker ps

      - name: Verify Services
        run: |
          echo "Verifying service health..."
          
          # Health checks
          curl -f http://localhost:8081/actuator/health && echo "Product Service OK"
          curl -f http://localhost:8082/actuator/health && echo "Order Service OK"

      - name: Test Product Service
        run: |
          echo "--- Testing Product Service ---"
          
          # POST - Create product
          curl -X POST http://localhost:8081/api/products \
            -H "Content-Type: application/json" \
            -d '{"name": "Keyboard", "price": 59.99, "quantity": 30}'
          
          # GET - List all products
          curl http://localhost:8081/api/products
          
          # GET - Get product by ID
          curl http://localhost:8081/api/products/1

      - name: Test Order Service
        run: |
          echo "--- Testing Order Service ---"
          
          # POST - Create order
          curl -X POST http://localhost:8082/api/orders \
            -H "Content-Type: application/json" \
            -d '{"productId": 1, "quantity": 3}'
          
          # GET - List all orders
          curl http://localhost:8082/api/orders
          
          # GET - Get order by ID
          curl http://localhost:8082/api/orders/1

      - name: Cleanup
        if: always()
        run: |
          docker-compose down
          echo "Cleanup completed"

  validation:
    name: Validation & Quality
    runs-on: ubuntu-latest
    needs: unit-tests
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Validate Project Structure
        run: |
          echo "Checking project structure..."
          [ -f "docker-compose.yml" ] && echo "docker-compose.yml exists"
          [ -d "product-service" ] && echo "product-service directory exists"
          [ -d "order-service" ] && echo "order-service directory exists"
          [ -d ".github/workflows" ] && echo "workflows directory exists"
          
          echo "All required files present"